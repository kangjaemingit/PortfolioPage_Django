version: '3'

services:
    nginx:
      build: ./nginx
      image: nginx:1.15-alpine
      restart: unless-stopped
      volumes:
        - static_volume:/usr/src/app/_static
        - media_volume:/usr/src/app/_media
        - ./data/nginx:/etc/nginx/conf.d
        - ./data/certbot/conf:/etc/letsencrypt
        - ./data/certbot/www:/var/www/certbot
      ports:
        - 80:80
        - 443:443
      command: "/bin/sh -c 'while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g \"daemon off;\"'"
      depends_on:
        - web
    certbot:
      image: certbot/certbot
      restart: unless-stopped
      entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
      volumes:
        - ./data/certbot/conf:/etc/letsencrypt
        - ./data/certbot/www:/var/www/certbot
    web:
      build: .
      command: gunicorn python_django_prj.wsgi:application --bind 0.0.0.0:8000
      volumes:
        - static_volume:/usr/src/app/_static
        - media_volume:/usr/src/app/_media
        - ./:/usr/src/app
      expose:
        - 8000
      env_file:
        - ./.env.prod
      depends_on:
        - db
    db:
      image: postgres:12.0-alpine
      volumes:
        - postgres_data:/var/lib/postgresql/data/
      env_file:
        - ./.env.prod.db
volumes:
  postgres_data:
  static_volume:
  media_volume: